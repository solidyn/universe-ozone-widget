UNIVERSE.EarthExtensions=function(d,e){var b=this,c=false,a=false;this.enableVisibilityLines=false;this.enableSensorProjections=false;this.enableSensorFootprintProjections=false;this.lockCameraToWithEarthRotation=false;this.rotationOffsetFromXAxis=0;this.useSunLighting=e||true;this.defaultObjects=new UNIVERSE.DefaultObjects(d);this.addEarth=function(f,h){var g=new UNIVERSE.Earth(d,b,f,h);d.addObject(g);d.updateOnce()};this.addMoon=function(g){var f=new UNIVERSE.Moon(d,b,g);d.addObject(f);d.updateOnce()};this.addSun=function(){var f=new UNIVERSE.Sun(d,b);d.addObject(f);d.updateOnce()};this.addSpaceObject=function(h,i){var g,f;d.getObjectFromLibraryById(h.modelId,function(j){g=j;d.getObjectFromLibraryById("default_material",function(k){d.addObject(h.getGraphicsObject(k,g,d,b));d.updateOnce();i()})})};this.addDefaultSpaceObject=function(g,f,k,s,r,o,m,p,l,i,h,q){var j=new UNIVERSE.ECICoordinates(r,o,m,p,l,i,0,0,0);var n=new UNIVERSE.SpaceObject(g,f,"",function(w,u){if(!w){w=d.getCurrentUniverseTime()}var v=w-h;dt=100;var t=OrbitPropagator.propagateOrbit(j,v/1000,dt,h);this.currentLocation=t;return t},true,true,[],j,d,b);n.showVehicle=true;this.addSpaceDot(n,k,s,q);return n};this.addSpaceDot=function(k,g,h,l){var i,f="dot_"+g;if(h){i="ground_dot_size_"+h}else{i="default_ground_object_geometry"}try{d.getObjectFromLibraryById(i,function(n){try{d.getObjectFromLibraryById(f,function(o){d.addObject(k.getGraphicsObject(o,n,d,b));d.updateOnce();l()})}catch(m){d.setObjectInLibrary(f,new THREE.MeshBasicMaterial({color:g}));b.addSpaceDot(k,g,h,l)}})}catch(j){d.setObjectInLibrary(i,new THREE.SphereGeometry(h,h/10,h/20));b.addSpaceDot(k,g,h,l)}};this.addSensorVisibilityLines=function(f,h){if(f.sensors&&f.sensors.length>0){var g=new UNIVERSE.SensorVisibilityLinesController(f,d,b);d.addObject(g);d.updateOnce();h()}};this.addGroundObject=function(g,j){var i,f,h;if(!g.modelId){g.modelId="default_ground_object_geometry";h="default_ground_object_material"}else{h="default_material"}d.getObjectFromLibraryById(g.modelId,function(k){i=k;d.getObjectFromLibraryById(h,function(l){d.addObject(g.getGraphicsObject(l,i,d,b));d.updateOnce();j()})})};this.addStaticGroundDot=function(h,g,i,n,l,f,k,m){var j=new UNIVERSE.GroundObject(h,g,null,function(){return CoordinateConversionTools.convertLLAtoECI(new UNIVERSE.LLACoordinates(l,f,k),CoordinateConversionTools.convertTimeToGMST(d.getCurrentUniverseTime()))});this.addGroundDot(j,i,n,m)};this.addGroundDot=function(f,h,i,l){var j,g="dot_"+h;if(i){j="ground_dot_size_"+i}else{j="default_ground_object_geometry"}try{d.getObjectFromLibraryById(j,function(n){try{d.getObjectFromLibraryById(g,function(o){d.addObject(f.getGraphicsObject(o,n,d,b));d.updateOnce();l()})}catch(m){d.setObjectInLibrary(g,new THREE.MeshBasicMaterial({color:h}));b.addGroundDot(f,h,i,l)}})}catch(k){d.setObjectInLibrary(j,new THREE.SphereGeometry(i,i/10,i/20));b.addGroundDot(f,h,i,l)}};this.addGroundTrackPointForObject=function(g,i){var h,f;d.getObjectFromLibraryById("default_ground_object_geometry",function(j){h=j;d.getObjectFromLibraryById("default_ground_track_material",function(k){var l=new UNIVERSE.GroundTrackPoint(g,d,b,k,h);d.addObject(l);d.updateOnce();i()})})};this.addPropogationLineForObject=function(g,i){var h,f;h=new THREE.Geometry();d.getObjectFromLibraryById("default_orbit_line_material",function(j){var k=new UNIVERSE.PropogationLine(g,d,b,j,h);d.addObject(k);d.updateOnce();i()})};this.addSensorProjection=function(f,i){var h=Utilities.eciTo3DCoordinates(i.propagator(undefined,false),b),g;if(h){g=UNIVERSE.SensorProjection(f,i,d,b,h);d.addObject(g);d.updateOnce()}};this.addSensorProjections=function(g,h){var f;if(g.sensors.length>0){for(f=g.sensors.length-1;f>=0;f-=1){this.addSensorProjection(g.sensors[f],g)}h()}};this.addSensorFootprintProjections=function(g,h){var f;if(g.sensors.length>0){for(f=0;f<g.sensors.length;f+=1){this.addSensorFootprintProjection(g.sensors[f],g)}h()}};this.addSensorFootprintProjection=function(g,h){var f=new UNIVERSE.SensorFootprintProjection(g,h,d,b);d.addObject(f);d.updateOnce()};this.addClosestGroundObjectTracingLine=function(f){var h,g=new UNIVERSE.GraphicsObject(f.id+"_controlLine",f.objectName,undefined,function(i){var k=Utilities.eciTo3DCoordinates(f.propagator(undefined,false),b),j=b.findClosestGroundObject(k);if(j!==undefined&&j.id!==h){b.removeLineBetweenObjects(f.id,h);h=j.id;b.addLineBetweenObjects(f.id,h)}},function(){});d.addObject(g);d.updateOnce()};this.addLineBetweenObjects=function(j,h,f,i){var g=new UNIVERSE.LineBetweenObjects(j,h,d,b,f,i);d.addObject(g)};this.removeLineBetweenObjects=function(i,g,h){var f="_to_";if(h){f=h}d.removeObject(i+f+g)};this.removeAllLinesBetweenObjects=function(){var f=d.getGraphicsObjects(),g;for(g in f){if(g.indexOf("_to_")>-1){d.removeObject(g)}}};this.findClosestGroundObject=function(f){if(f){var g=new THREE.Vector3(f.x,f.y,f.z);g.multiplyScalar(Constants.radiusEarth/g.length());return b.findClosestObject({x:g.x,y:g.y,z:g.z})}return undefined};this.findClosestObject=function(g){var h=d.getGraphicsObjects(),n,l,k=new THREE.Vector3(g.x,g.y,g.z),j,f,m;for(j in h){if(h[j].currentLocation){f=new THREE.Vector3(h[j].currentLocation.x,h[j].currentLocation.y,h[j].currentLocation.z);m=f.distanceTo(k);if(n===undefined||m<n){l=h[j];n=m}}}return l};this.showAllOrbitLines=function(h){var f=d.getGraphicsObjects(),g;a=h;for(g in f){if(f[g].id.indexOf("_propogation")!==-1){d.showObject(f[g].id,h)}}};this.showOrbitLineForObject=function(f,g){d.showObject(g+"_propogation",f)};this.showModelForId=function(f,g){d.showObject(g,f)};this.showAllGroundTracks=function(h){var f=d.getGraphicsObjects(),g;c=h;for(g in f){if(f[g].id.indexOf("_groundPoint")!==-1){d.showObject(f[g].id,h)}}};this.showGroundTrackForId=function(f,g){d.showObject(g+"_groundPoint",f)};this.showAllSensorProjections=function(h){var f=d.getGraphicsObjects(),g;this.enableSensorProjections=h;for(g in f){if(f[g].id.indexOf("_sensorProjection")!==-1){d.showObject(f[g].id,h)}}};this.showSensorProjectionForId=function(g,j){var h=d.getGraphicsObjects(),f;for(f in h){if(f.indexOf(j+"_sensorProjection")>-1){d.showObject(f,g)}}};this.showAllSensorFootprintProjections=function(h){var f=d.getGraphicsObjects(),g;this.enableSensorFootprintProjections=h;for(g in f){if(f[g].id.indexOf("_footprint")!==-1){d.showObject(f[g].id,h)}}};this.showSensorFootprintProjectionsForId=function(h,j){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id.indexOf(j)!==-1&&f[g].id.indexOf("_footprint")!==-1){d.showObject(f[g].id,h)}}};this.showSensorVisibilityLinesForId=function(h,j){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id.indexOf(j+"_visibility_")!==-1){d.showObject(f[g].id,h)}}};this.showAllSensorVisibilityLines=function(h){var f=d.getGraphicsObjects(),g;this.enableVisibilityLines=h;for(g in f){if(f[g].id.indexOf("_visibility_")!==-1){d.showObject(f[g].id,h)}}};this.showAllLinesBetweenObjects=function(h){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id.indexOf("_to_")!==-1){d.showObject(f[g].id,h)}}};this.showLineBetweenObjectsForId=function(h,j){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id.indexOf(j+"_to_")!==-1||f[g].id.indexOf("_to_"+j)!==-1){d.showObject(f[g].id,h)}}};this.lockCameraPositionRelativeToEarth=function(f){this.lockCameraToWithEarthRotation=f};this.setSunLighting=function(f){b.useSunLighting=f;d.showObject("earth",!f);d.showObject("earth_day",f);d.showObject("earth_night",f)};this.removeAllExceptEarthAndMoon=function(){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id!=="earth"&&f[g].id!=="moon"&&f[g].id!=="sun"){d.removeObject(f[g].id)}}};this.setup=function(){this.removeAllExceptEarthAndMoon();d.setup()}};UNIVERSE.DefaultObjects=function(a){a.setObjectInLibrary("default_ground_object_geometry",new THREE.SphereGeometry(200,20,10));a.setObjectInLibrary("default_ground_object_material",new THREE.MeshBasicMaterial({color:13369344}));a.setObjectInLibrary("default_ground_track_material",new THREE.MeshBasicMaterial({color:13369344,transparent:true,opacity:0.4,blending:THREE.AdditiveBlending}));a.setObjectInLibrary("default_orbit_line_material",new THREE.LineBasicMaterial({color:10027008,opacity:1}));a.setObjectInLibrary("default_ground_object_tracing_line_material",new THREE.LineBasicMaterial({color:39168,opacity:1}));this.sensorColors={colorList:["0xff0000","0x00cc00","0x0066ff","0x9900cc","0xffff00","0xff6666","0xebebeb","0xffaa00"],iterator:-1,nextColor:function(){this.iterator=(this.iterator+1)%this.colorList.length;return this.colorList[this.iterator]}}};UNIVERSE.Earth=function(h,f,d,l){var k=40,j=30,n=new THREE.SphereGeometry(Constants.radiusEarth,k,j),o=THREE.ImageUtils.loadTexture(d),e=THREE.ImageUtils.loadTexture(l),p=new THREE.MeshBasicMaterial({color:16777215,overdraw:true,map:e,blending:THREE.AdditiveBlending}),g=new THREE.Mesh(n,p),c=new THREE.MeshPhongMaterial({map:o,color:16777215,transparent:true,blending:THREE.AdditiveBlending}),b=new THREE.Mesh(n,c),i=new THREE.MeshBasicMaterial({color:16777215,overdraw:true,map:o,blending:THREE.AdditiveBlending}),a=new THREE.Mesh(n,i),q=CoordinateConversionTools.convertTimeToGMST(h.getCurrentUniverseTime()),m=new UNIVERSE.GraphicsObject("earth","earth",{x:0,y:0,z:0},function(r){var s=MathTools.toRadians(CoordinateConversionTools.convertTimeToGMST(h.getCurrentUniverseTime()));if(f.lockCameraToWithEarthRotation){f.rotationOffsetFromXAxis+=(s-q);if(f.rotationOffsetFromXAxis>(2*Math.PI)){f.rotationOffsetFromXAxis-=(2*Math.PI)}}else{b.rotation.y=s-f.rotationOffsetFromXAxis;g.rotation.y=s-f.rotationOffsetFromXAxis;a.rotation.y=s-f.rotationOffsetFromXAxis}q=s},function(){h.draw(this.id+"_day",b,false);h.draw(this.id+"_night",g,false);h.draw(this.id,a,false);f.setSunLighting(f.useSunLighting)});return m};var UNIVERSE=UNIVERSE||{};UNIVERSE.EllipseSensorShape=function(b,a,c){this.shapeName=b;this.semiMajorAngle=a;this.semiMinorAngle=c;this.getSemiMajorAngle=function(){return this.semiMajorAngle};this.setSemiMajorAngle=function(d){this.semiMajorAngle=d};this.getSemiMinorAngle=function(){return this.semiMinorAngle};this.setSemiMinorAngle=function(d){this.semiMinorAngle=d};this.getAngularExtentOfSensorAtSpecifiedAzimuth=function(g){if((this.semiMajorAngle===0)&&(this.semiMinorAngle===0)){return 0}else{var e=MathTools.toRadians(this.semiMajorAngle),d=MathTools.toRadians(this.semiMinorAngle),h=Math.cos(MathTools.toRadians(g)),f=Math.sin(MathTools.toRadians(g));return MathTools.toDegrees(e*d/Math.sqrt((d*h)*(d*h)+(e*f)*(e*f)))}};this.canSensorSeePointAtAzEl=function(f,g){var e=false,d=this.getAngularExtentOfSensorAtSpecifiedAzimuth(f);if(d>g){e=true}return e}};var UNIVERSE=UNIVERSE||{};UNIVERSE.GroundObject=function(d,c,b,a){if(!d){return undefined}this.id=d;this.objectName=c||d;this.propagator=a;this.modelId=b;return this};UNIVERSE.GroundObject.prototype={constructor:UNIVERSE.GroundObject,set:function(d,c,a,b){this.id=d;this.objectName=c||d;this.propagator=a;this.modelId=b;return this},getGraphicsObject:function(b,f,g,e){f.applyMatrix(new THREE.Matrix4().setRotationFromEuler(new THREE.Vector3(Math.PI/2,Math.PI,0)));var c=new THREE.Mesh(f,b),a=this,d=new UNIVERSE.GraphicsObject(this.id,this.objectName,undefined,function(j){var k=a.propagator(),i=Utilities.eciTo3DCoordinates(k,e),h=new THREE.Vector3(i.x,i.y,i.z);c.position.set(i.x,i.y,i.z);this.currentLocation=k;h.multiplyScalar(1.4);c.lookAt(h)},function(){g.draw(a.id,c,true)});return d}};var UNIVERSE=UNIVERSE||{};UNIVERSE.GroundTrackPoint=function(b,g,e,d,f){var a=new THREE.Mesh(f,d),c=new UNIVERSE.GraphicsObject(b.id+"_groundPoint",b.objectName,undefined,function(j){var i=b.propagator(undefined,false),k=Utilities.eciTo3DCoordinates(i,e),h;if(k){h=new THREE.Vector3(k.x,k.y,k.z);h.multiplyScalar(Constants.radiusEarth/h.length());a.position.copy(h)}this.currentLocation=i},function(){g.draw(this.id,a,true)});return c};var UNIVERSE=UNIVERSE||{};UNIVERSE.LineBetweenObjects=function(a,k,g,e,d,o){var c,m,l=g.getGraphicsObjectById(a),j=g.getGraphicsObjectById(k),b,i,n,h,f;if(!d){d=39168}m=new THREE.LineBasicMaterial({color:d,opacity:1});if(!l||!j){return undefined}b=Utilities.eciTo3DCoordinates(l.currentLocation,e);i=Utilities.eciTo3DCoordinates(j.currentLocation,e);if(!b||!i){return undefined}c=new THREE.Geometry();c.vertices.push(new THREE.Vector3(b.x,b.y,b.z));c.vertices.push(new THREE.Vector3(i.x,i.y,i.z));n=new THREE.Line(c,m);h="_to_";if(o){h=o}f=new UNIVERSE.GraphicsObject(a+h+k,undefined,undefined,function(p){var r=g.getGraphicsObjectById(a),q=g.getGraphicsObjectById(k),t,s;if(!r||!q){return}t=Utilities.eciTo3DCoordinates(r.currentLocation,e);s=Utilities.eciTo3DCoordinates(q.currentLocation,e);if(t&&s){c.vertices[0].position=new THREE.Vector3(t.x,t.y,t.z);c.vertices[1]=new THREE.Vector3(s.x,s.y,s.z);c.verticesNeedUpdate=true}},function(){g.draw(this.id,n,false)});return f};UNIVERSE.Moon=function(h,g,k){var l=40,b=30,e=1737.1,j=new THREE.SphereGeometry(e,l,b),i=THREE.ImageUtils.loadTexture(k),c=new THREE.MeshPhongMaterial({map:i,color:16777215,transparent:true,blending:THREE.AdditiveBlending}),d=new THREE.Mesh(j,c),m=new THREE.MeshBasicMaterial({color:16777215,overdraw:true,map:i,blending:THREE.AdditiveBlending}),f=new THREE.Mesh(j,m),a=new UNIVERSE.GraphicsObject("moon","moon",undefined,function(n){var q=new Date(h.getCurrentUniverseTime()),p=CoordinateConversionTools.getMoonPositionECIAtCurrentTime(q),o=Utilities.eciTo3DCoordinates({x:p.x,y:p.y,z:p.z},g);d.position={x:o.x,y:o.y,z:o.z};f.position={x:o.x,y:o.y,z:o.z};this.currentLocation=p},function(){h.draw(this.id+"_day",d,false);h.draw(this.id,f,false);g.setSunLighting(g.useSunLighting)});return a};var UNIVERSE=UNIVERSE||{};UNIVERSE.PropogationLine=function(d,k,g,l,n){var a=new Date(k.getCurrentUniverseTime()),m=1440,c=[],f,o,h,b,e,i;for(f=0;f<m;f+=5){o=d.propagator(a,false);c.push(o);h=Utilities.eciTo3DCoordinates(o,g);if(h){b=new THREE.Vector3(h.x,h.y,h.z);n.vertices.push(b)}a.setMinutes(a.getMinutes()+5)}e=new THREE.Line(n,l);i=new UNIVERSE.GraphicsObject(d.id+"_propogation",d.objectName,undefined,function(j){if(g.lockCameraToWithEarthRotation){var r=c.length,p,q;for(p=0;p<r;p+=1){q=Utilities.eciTo3DCoordinates(c[p],g);if(q&&e.geometry.vertices[p]){e.geometry.vertices[p]=new THREE.Vector3(q.x,q.y,q.z)}}e.geometry.verticesNeedUpdate=true}},function(){k.draw(this.id,e,false)});return i};var UNIVERSE=UNIVERSE||{};UNIVERSE.RectangleSensorShape=function(b,c,a){this.shapeName=b;this.width=c;this.height=a;this.getHeight=function(){return this.height};this.setHeight=function(d){this.height=d};this.getWidth=function(){return this.width};this.setWidth=function(d){this.width=d};this.getAngularExtentOfSensorAtSpecifiedAzimuth=function(i){if((this.height===0)&&(this.width===0)){return 0}else{var f=MathTools.toDegrees(Math.atan(this.height/this.width)),j=180-f,d=180+f,h=360-f,g,e;if(i<0){i+=360}g=Math.abs(this.width/(2*Math.cos(MathTools.toRadians(i))));e=Math.abs(this.height/(2*Math.sin(MathTools.toRadians(i))));if(i<f){return g}else{if(i<j){return e}else{if(i<d){return g}else{if(i<h){return e}else{return g}}}}}};this.canSensorSeePointAtAzEl=function(f,g){var e=false,d=this.getAngularExtentOfSensorAtSpecifiedAzimuth(f);if(d>g){e=true}return e}};UNIVERSE.Sensor=function(b,a){this.name=b;this.shape=a;this.quaternionFromRSWToSensor=new Quaternion();this.rotationRadians=MathTools.toRadians(180);this.rotationAxis={x:0,y:0,z:1};this.quaternionFromRSWToSensor.setW(Math.cos(this.rotationRadians/2));this.quaternionFromRSWToSensor.setX(Math.sin(this.rotationRadians/2)*this.rotationAxis.x);this.quaternionFromRSWToSensor.setY(Math.sin(this.rotationRadians/2)*this.rotationAxis.y);this.quaternionFromRSWToSensor.setZ(Math.sin(this.rotationRadians/2)*this.rotationAxis.z);this.rotateSensorAboutRadialVector=function(f){if(f&&f!==0){var e=new Quaternion(),c=MathTools.toRadians(f),d={x:1,y:0,z:0};e.setW(Math.cos(c/2));e.setX(Math.sin(c/2)*d.x);e.setY(Math.sin(c/2)*d.y);e.setZ(Math.sin(c/2)*d.z);this.quaternionFromRSWToSensor=QuaternionMath.multiplyQuaternions(e,this.quaternionFromRSWToSensor)}};this.rotateSensorAboutAlongTrackVector=function(f){if(f&&f!==0){var e=new Quaternion(),c=MathTools.toRadians(f),d={x:0,y:1,z:0};e.setW(Math.cos(c/2));e.setX(Math.sin(c/2)*d.x);e.setY(Math.sin(c/2)*d.y);e.setZ(Math.sin(c/2)*d.z);this.quaternionFromRSWToSensor=QuaternionMath.multiplyQuaternions(e,this.quaternionFromRSWToSensor)}};this.rotateSensorAboutCrossTrackVector=function(f){if(f&&f!==0){var e=new Quaternion(),c=MathTools.toRadians(f),d={x:0,y:0,z:1};e.setW(Math.cos(c/2));e.setX(Math.sin(c/2)*d.x);e.setY(Math.sin(c/2)*d.y);e.setZ(Math.sin(c/2)*d.z);this.quaternionFromRSWToSensor=QuaternionMath.multiplyQuaternions(e,this.quaternionFromRSWToSensor)}};this.getSensorQuaternionRSW=function(){return this.quaternionFromRSWToSensor};this.setSensorQuaternionRSW=function(c){this.quaternionFromRSWToSensor=c};this.getName=function(){return this.name};this.setName=function(c){this.name=c};this.getShape=function(){return this.shape};this.setShape=function(c){this.shape=c};this.determineTargetAzElRelativeToSensor=function(F,l){var f=F.getEci(),x=new THREE.Vector3(l.x-f.getX(),l.y-f.getY(),l.z-f.getZ()),u=new THREE.Vector3(f.getX(),f.getY(),f.getZ()),n=new THREE.Vector3(f.getVX(),f.getVY(),f.getVZ()),h=u.length(),j=new THREE.Vector3(),p=new THREE.Vector3(),m=new THREE.Vector3(),q=new THREE.Vector3(),E,D,y,z,o,A,I,B,L,K,J,H,G,i,t,k,g;j.cross(u,n);p.copy(u);p.divideScalar(h);m.copy(j);m.divideScalar(j.length());q.cross(m,u);E=x.dot(p);D=x.dot(q);y=x.dot(m);z=new THREE.Vector3(E/p.length(),D/q.length(),y/m.length());o=QuaternionMath.applyQuaternionRotation(this.quaternionFromRSWToSensor,z);A=new THREE.Vector3(1,0,0);I=new THREE.Vector3(1,-Math.tan(MathTools.toRadians(this.shape.getAngularExtentOfSensorAtSpecifiedAzimuth(0))),0);B=new THREE.Vector3(1,0,Math.tan(MathTools.toRadians(this.shape.getAngularExtentOfSensorAtSpecifiedAzimuth(90))));L=MathTools.toRadians(MathTools.angleBetweenTwoVectorsVector(A,I));K=MathTools.toRadians(MathTools.angleBetweenTwoVectorsVector(A,o));J=MathTools.toRadians(MathTools.angleBetweenTwoVectorsVector(I,o));H=MathTools.toRadians(MathTools.angleBetweenTwoVectorsVector(B,o));G=MathTools.toRadians(MathTools.angleBetweenTwoVectorsVector(B,A));i=0.5*(L+K+J);t=2*Math.asin(Math.sqrt((Math.sin(Math.abs(i-L))*Math.sin(Math.abs(i-K))/(Math.sin(L)*Math.sin(K)))));k=MathTools.toDegrees(t);g=MathTools.toDegrees(K);if(H>K&&H>G){k=360-k}return{az:k,el:g}};this.checkToSeeIfEarthObscuresLineBetweenSatelliteAndTargetSphericalEarth=function(n,i){var e=false,g=Constants.radiusEarth,l=n.getEci(),f=new THREE.Vector3(l.getX()/g,l.getY()/g,l.getZ()/g),d=new THREE.Vector3(i.getX()/g,i.getY()/g,i.getZ()/g),m=f.length(),k=d.length(),c=0.5,j=0,h;if(m<1||k<1){e=false}else{h=f.dot(d);c=(m*m-h)/(m*m+k*k-2*h);if(c<0||c>1){e=true}else{j=(1-c)*m*m+h*c;if(j>=1){e=true}}}return !e};this.checkToSeeIfEarthObscuresLineBetweenSatelliteAndTargetOblateEarth=function(n,i){var e=false,g=Constants.radiusEarth,l=n.getEci(),f=new THREE.Vector3(l.getX()/g,l.getY()/g,l.getZ()/g),d=new THREE.Vector3(i.getX()/g,i.getY()/g,i.getZ()/g),m=f.length(),k=d.length(),c=0.5,j=0,h;h=f.dot(d);c=(m*m-h)/(m*m+k*k-2*h);if(c<0||c>1){e=true}else{j=(1-c)*m*m+h*c;if(j>=1){e=true}}return !e};this.checkSensorVisibilityOfTargetPoint=function(d,e){var f=this.determineTargetAzElRelativeToSensor(d,e),c=this.shape.canSensorSeePointAtAzEl(f.az,f.el),g=this.checkToSeeIfEarthObscuresLineBetweenSatelliteAndTargetOblateEarth(d,e);if(g){return false}else{if(c===true&&g===false){return true}else{return false}}};this.buildPointsToDefineSensorShapeInECI=function(o,m){var r=[],c=360/o,h,p,d,f,n,q,k,l,j,e,g;for(h=0;h<o;h+=1){p=h*c;d=MathTools.toRadians(this.shape.getAngularExtentOfSensorAtSpecifiedAzimuth(p));f=new THREE.Vector3(1,d*Math.cos(MathTools.toRadians(p)),d*Math.sin(MathTools.toRadians(p)));n=f.length();f=f.divideScalar(n);f=QuaternionMath.applyQuaternionRotation(this.quaternionFromRSWToSensor,f);q=new UNIVERSE.RSWCoordinates(f.x,f.y,f.z);k=m.getEci();l=k.getX();j=k.getY();e=k.getZ();g=CoordinateConversionTools.convertRSWToECI(m,q);r[h]=new THREE.Vector3(l+g.getX(),j+g.getY(),e+g.getZ())}return r};this.findProjectionPoints=function(n,A,F){var g=A.getEci(),t=new THREE.Vector3(g.x,g.y,g.z),h=new THREE.Vector3(-t.x,-t.y,-t.z),v=[],K=n.length,D,s,B,L,p,J,l=100,w=Constants.radiusEarth+l,z,C,f,u,E,e,d,y,M,H,x,o,m,k,G,j,q;for(D=0;D<K;D+=1){s=new THREE.Vector3(n[D].x-t.x,n[D].y-t.y,n[D].z-t.z);B=t.length();L=B+F;p=s;J=h;z=p.dot(J);C=J.dot(J);f=z*z-C+w*w;if(f>=0){u=Math.sqrt(z*z-C+w*w);E=z+u;e=z-u;d=new THREE.Vector3(s.x*e+t.x,s.y*e+t.y,s.z*e+t.z);if(d.x){v.push(d)}}else{y=new THREE.Vector3();y.copy(s);y.multiplyScalar(L);M=new THREE.Vector3();M.copy(h);M.divideScalar(B);H=Math.acos(s.dot(M));x=B*Math.sin(H);o=x/Math.atan(H);m=o/L;k=new THREE.Vector3((y.x)*m+t.x,(y.y)*m+t.y,(y.z)*m+t.z);G=k.length();j=(Constants.radiusEarth+l)/G;q=new THREE.Vector3();q.copy(k);q.multiplyScalar(j);v.push(q)}}return v}};var UNIVERSE=UNIVERSE||{};UNIVERSE.SensorFootprintProjection=function(b,e,i,g,d){var m=new THREE.LineBasicMaterial({color:Utilities.get_random_color(),opacity:0.5,linewidth:3}),c=new THREE.Geometry(),l=b.buildPointsToDefineSensorShapeInECI(40,e),k=b.findProjectionPoints(l,e,1000),f,a,n,h;for(f=0;f<k.length;f+=1){a=new THREE.Vector3(-k[f].x,k[f].z,k[f].y);c.vertices.push(a)}c.vertices.push(new THREE.Vector3(-k[0].x,k[0].z,k[0].y));n=new THREE.Line(c,m);h=new UNIVERSE.GraphicsObject(e.id+"_footprint_"+b.name,undefined,undefined,function(o){if(g.enableSensorFootprintProjections){var r=this.sensor.buildPointsToDefineSensorShapeInECI(40,e),s=this.sensor.findProjectionPoints(r,e,1000),j,q,p;for(j=0;j<s.length;j+=1){q=Utilities.eciTo3DCoordinates(s[j],g);n.geometry.vertices[j]=new THREE.Vector3(q.x,q.y,q.z)}p=Utilities.eciTo3DCoordinates(s[0],g);n.geometry.vertices[s.length]=new THREE.Vector3(p.x,p.y,p.z);n.geometry.verticesNeedUpdate=true}},function(){i.draw(this.id,n,false)});h.sensor=b;return h};var UNIVERSE=UNIVERSE||{};UNIVERSE.SensorProjection=function(c,f,k,h,e){var b=30,p=c.buildPointsToDefineSensorShapeInECI(b,f),n=c.findProjectionPoints(p,f,1000),a=new Array(n.length),m=n.length,g,i,d,o,q,l;for(g=0;g<m;g+=1){i=Utilities.eciTo3DCoordinates(n[g],h);a[g]=i}d=new UNIVERSE.SensorProjectionGeometry(e,a);o=new THREE.MeshBasicMaterial({color:h.defaultObjects.sensorColors.nextColor(),transparent:true,blending:THREE.AdditiveBlending,opacity:0.15,overdraw:true});q=new THREE.Mesh(d,o);q.doubleSided=true;l=new UNIVERSE.GraphicsObject(f.id+"_sensorProjection_"+c.name,f.objectName,undefined,function(r){if(h.enableSensorProjections){var v=Utilities.eciTo3DCoordinates(f.propagator(undefined,false),h),t,u,s,w;if(v){t=c.buildPointsToDefineSensorShapeInECI(b,f);u=c.findProjectionPoints(t,f,1000);a=[];for(s=0;s<m;s+=1){w=Utilities.eciTo3DCoordinates(u[s],h);a[s]=w}q.geometry.recalculateVertices(v,a)}}},function(){k.draw(this.id,q,false)});return l};var UNIVERSE=UNIVERSE||{};UNIVERSE.SensorProjectionGeometry=function(r,l){THREE.Geometry.call(this);var w=1,n,m,f=[],o=[],z,e,g,p,s,q=0,t=[],E=[],d,c,b,a,k,j,i,h,D,C,B,A;l.push(l[0]);z=l.length-1;for(n=0;n<=z;n+=1){s=n/z;e=r.x;g=r.y;p=r.z;this.vertices.push(new THREE.Vector3(e,g,p));t.push(this.vertices.length-1);E.push(new THREE.UV(s,q))}f.push(t);o.push(E);q=1;t=[];E=[];for(n=0;n<=z;n+=1){s=n/z;e=l[n].x;g=l[n].y;p=l[n].z;this.vertices.push(new THREE.Vector3(e,g,p));t.push(this.vertices.length-1);E.push(new THREE.UV(s,q))}f.push(t);o.push(E);for(m=0;m<w;m+=1){for(n=0;n<z;n+=1){d=f[m][n];c=f[m+1][n];b=f[m+1][n+1];a=f[m][n+1];k=this.vertices[d].position.clone().setY(0).normalize();j=this.vertices[c].position.clone().setY(0).normalize();i=this.vertices[b].position.clone().setY(0).normalize();h=this.vertices[a].position.clone().setY(0).normalize();D=o[m][n].clone();C=o[m+1][n].clone();B=o[m+1][n+1].clone();A=o[m][n+1].clone();this.faces.push(new THREE.Face4(d,c,b,a,[k,j,i,h]));this.faceVertexUvs[0].push([D,C,B,A])}}this.computeCentroids();this.computeFaceNormals();this.dynamic=true};UNIVERSE.SensorProjectionGeometry.prototype=new THREE.Geometry();UNIVERSE.SensorProjectionGeometry.prototype.constructor=UNIVERSE.SensorProjectionGeometry;UNIVERSE.SensorProjectionGeometry.prototype.recalculateVertices=function(a,i){i.push(i[0]);this.dynamic=true;var f=i.length,e=1,c,b,g,h,d;for(d=0;d<f;d+=1){h=d/f;c=a.x;b=a.y;g=a.z;this.vertices[d]=new THREE.Vector3(c,b,g)}for(d=0;d<f;d+=1){h=d/f;c=i[d].x;b=i[d].y;g=i[d].z;this.vertices[d+f]=new THREE.Vector3(c,b,g)}this.verticesNeedUpdate=true};var UNIVERSE=UNIVERSE||{};UNIVERSE.SensorVisibilityLinesController=function(a,c,b){var d=new UNIVERSE.GraphicsObject(a.id+"_visibilityLines",a.objectName,undefined,function(q){if(b.enableVisibilityLines){var n=a.sensors.length,p=c.getGraphicsObjects(),f=[],m,h,g,e,l,o;for(m=0;m<n;m+=1){e=a.sensors[m];for(h in p){l=p[h];if(l.currentLocation!==undefined&&l.modelName!=="earth"&&l.modelName!=="moon"&&l.modelName!=="sun"&&l.id!==a.id&&l.id.indexOf("_groundPoint")===-1&&l.id.indexOf("_propagation")===-1&&l.id.indexOf("_to_")===-1&&l.id.indexOf("_visibility_")===-1){o=e.checkSensorVisibilityOfTargetPoint(a,l.currentLocation);if(!f[l.id]){f[l.id]=o}}}}for(g in f){if(f[g]){if(c.getGraphicsObjectById(a.id+"_visibility_"+g)===undefined){b.addLineBetweenObjects(a.id,g,undefined,"_visibility_")}}else{b.removeLineBetweenObjects(a.id,g,"_visibility_")}}}b.showAllSensorVisibilityLines(b.enableVisibilityLines)},function(){});return d};UNIVERSE.SpaceObject=function(a,f,i,c,e,j,b,h,g,d){if(!a){return undefined}this.id=a;this.objectName=f||a;this.propagator=c;this.modelId=i;this.showPropagationLine=e||false;this.showGroundTrackPoint=j||false;this.sensors=b||undefined;this.currentLocation=h||undefined;this.universe=g||undefined;this.earthExtensions=d||undefined};UNIVERSE.SpaceObject.prototype={constructor:UNIVERSE.SpaceObject,set:function(a,e,c,h,i,j,b,g,f,d){this.id=a;this.objectName=e||a;this.propagator=c;this.modelId=h;this.showPropagationLine=i||false;this.showGroundTrackPoint=j||false;this.sensors=b||undefined;this.currentLocation=g||undefined;this.universe=f||undefined;this.earthExtensions=d||undefined;return this},getEci:function(){return this.currentLocation},getGraphicsObject:function(b,c,f,a){this.universe=f;this.earthExtensions=a;var e=this,d,g;c.applyMatrix(new THREE.Matrix4().setRotationFromEuler(new THREE.Vector3(-Math.PI/2,0,0)));d=new THREE.Mesh(c,b);g=new UNIVERSE.GraphicsObject(this.id,this.objectName,undefined,function(i){var h=e.propagator(),j=Utilities.eciTo3DCoordinates(h,a);if(j){d.position.set(j.x,j.y,j.z);d.lookAt(new THREE.Vector3(0,0,0));this.currentLocation=h}},function(){e.universe.draw(this.id,d,false);e.earthExtensions.showModelForId(e.showVehicle,this.id)});return g}};UNIVERSE.Sun=function(c,b){var a=new UNIVERSE.GraphicsObject("sun","sun",undefined,function(d){var f=CoordinateConversionTools.getSunPositionECIAtCurrentTime(c.getCurrentUniverseTime()),e=Utilities.eciTo3DCoordinates({x:f.x,y:f.y,z:f.z},b);c.updateLight(e.x,e.y,e.z,1.5);this.currentLocation=f},function(){c.draw(this.id,undefined,false)});return a};var NearCircularPropagator={propagateOrbit:function(c,k,s,d){var H=c.getMeanAnomaly()+c.getMeanMotion()*k,n=MathTools.toRadians(c.getArgOfPerigee()),C=MathTools.toRadians(c.getRaan()),l=MathTools.toRadians(c.getInclination()),o=c.getEccentricity(),u=Constants.muEarth,b,B=0.00001,D,a,G,v,t,E,m,j,g,q,A,F,e=new UNIVERSE.ECICoordinates();H=MathTools.toRadians(H);b=H*0.95;for(D=0;D<500;D+=1){a=H-(b-o*Math.sin(b));if(Math.abs(a)>B){if(a>0){b=b+Math.abs(H-b)/2}else{if(a<0){b=b-Math.abs(H-b)/2}}}else{break}}G=2*Math.atan(Math.sqrt((1+o)/(1-o))*Math.tan(b/2));v=c.getSemimajorAxis()*(1-o*o);t=c.getSemimajorAxis()*(1-o*Math.cos(b));E=Math.sqrt(u*c.getSemimajorAxis()*(1-o*o));m=t*(Math.cos(C)*Math.cos(n+G)-Math.sin(C)*Math.sin(n+G)*Math.cos(l));j=t*(Math.sin(C)*Math.cos(n+G)+Math.cos(C)*Math.sin(n+G)*Math.cos(l));g=t*Math.sin(l)*Math.sin(n+G);q=((m*E*o)/(t*v))*Math.sin(G)-(E/t)*(Math.cos(C)*Math.sin(n+G)+Math.sin(C)*Math.cos(n+G)*Math.cos(l));A=((j*E*o)/(t*v))*Math.sin(G)-(E/t)*(Math.sin(C)*Math.sin(n+G)-Math.cos(C)*Math.cos(n+G)*Math.cos(l));F=((g*E*o)/(t*v))*Math.sin(G)+(E/t)*(Math.sin(l)*Math.cos(n+G));e.setX(m);e.setY(j);e.setZ(g);e.setVX(q);e.setVY(A);e.setVZ(F);e.setAX(0);e.setAY(0);e.setAZ(0);return e}};var OrbitPropagator={propagateOrbit:function(e,c,d,b){var a=CoordinateConversionTools.convertECIToKeplerian(e);if(c===0||isNaN(a.getEccentricity())){return e}else{if(a.getEccentricity()<=0.1){return NearCircularPropagator.propagateOrbit(a,c,d,b)}else{return RungeKuttaFehlbergPropagator.propagateOrbit(e,c,d,b)}}}};var RungeKuttaFehlbergPropagator={rungeKuttaFehlbergIntegrator:function(a,o,q,d){var p=a,z=[],c=[],s=0,k=1,x=q,r=0.02,y=d.getTime(),u,w,n,m,l,g,e,b,v,t;if(q>r){x=r}k=o/x;for(u=1;u<=k;u+=1){y=y+(x*1000);w=new Date(y);t=CoordinateConversionTools.convertTimeToGMST(w);n=[];m=[];l=[];g=[];e=[];b=[];for(v=0;v<9;v+=1){c[v]=p[v]}s=x;z=this.generateStateUpdate(c,s,t);for(v=0;v<9;v+=1){n[v]=x*z[v]}for(v=0;v<9;v+=1){c[v]=p[v]+0.25*n[v]}s=0.25*x;z=this.generateStateUpdate(c,s,t);for(v=0;v<9;v+=1){m[v]=x*z[v]}for(v=0;v<9;v+=1){c[v]=p[v]+(3/32)*n[v]+(9/32)*m[v]}s=0.375*x;z=this.generateStateUpdate(c,s,t);for(v=0;v<9;v+=1){l[v]=x*z[v]}for(v=0;v<9;v+=1){c[v]=p[v]+((1932/2197)*n[v])-((7200/2197)*m[v])+((7296/2197)*l[v])}s=0.9230769230769231*x;z=this.generateStateUpdate(c,s,t);for(v=0;v<9;v+=1){g[v]=x*z[v]}for(v=0;v<9;v+=1){c[v]=p[v]+((439/216)*n[v])-(8*m[v])+((3680/513)*l[v])-((845/4104)*g[v])}s=x;z=this.generateStateUpdate(c,s,t);for(v=0;v<9;v+=1){e[v]=x*z[v]}for(v=0;v<9;v+=1){c[v]=p[v]-((8/27)*n[v])+((2)*m[v])-((3544/2565)*l[v])+((1859/4104)*g[v])-((11/40)*e[v])}s=(0.5)*x;z=this.generateStateUpdate(c,s,t);for(v=0;v<9;v+=1){b[v]=x*z[v]}for(v=0;v<9;v+=1){p[v]=p[v]+((16/135)*n[v])+((6656/12825)*l[v])+((28561/56430)*g[v])-((9/50)*e[v])+((2/55)*b[v])}}return p},generateStateUpdate:function(f,e,d){var a=[],b=Constants.muEarth,c=Math.sqrt((f[0]*f[0])+(f[1]*f[1])+(f[2]*f[2]));a[0]=f[3];a[1]=f[4];a[2]=f[5];a[3]=-b*f[0]/(c*c*c);a[4]=-b*f[1]/(c*c*c);a[5]=-b*f[2]/(c*c*c);a[6]=0;a[7]=0;a[8]=0;return a},propagateOrbit:function(g,c,e,b){var f=[],d,a;f[0]=g.x;f[1]=g.y;f[2]=g.z;f[3]=g.vx;f[4]=g.vy;f[5]=g.vz;f[6]=g.ax;f[7]=g.ay;f[8]=g.az;d=this.rungeKuttaFehlbergIntegrator(f,c,e,b);a=new UNIVERSE.ECICoordinates(d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8]);return a}};var Constants={radiusEarth:6378.1363,muEarth:398600.4418,eccEarthSphere:0.081819221456,piOverOneEighty:0.01745329251,oneEightyOverPi:57.295779513};var CoordinateConversionTools={convertCurrentEpochToJulianDate:function(f){var c=0,e=f.getUTCFullYear(),g=f.getUTCMonth()+1,b=f.getUTCDate(),a=f.getUTCHours(),h=f.getUTCMinutes(),d=f.getUTCSeconds()+(f.getUTCMilliseconds()/1000);c=367*e-Math.floor((7*(e+Math.floor(((g+9)/12)))/4))+Math.floor((275*g/9))+(b)+1721013.5+((d/60+h)/60+a)/24;return c},convertTimeToGMST:function(d){var c=this.convertCurrentEpochToJulianDate(d),b=(c-2451545)/36525,a=67310.54841+(876600*3600+8640184.812866)*b+0.093104*b*b-(0.0000062)*b*b*b,e=Math.floor(a/86400);a=a-e*86400;a=a/240;if(a<0){a=a+360}return a},convertLLAtoECEF:function(j){var i=MathTools.toRadians(j.getLatitude()),b=MathTools.toRadians(j.getLongitude()),c=Constants.radiusEarth,m=Constants.eccEarthSphere,d=Math.sin(i),g=j.getAltitude(),e=c/Math.sqrt(1-m*m*d*d),a=c*(1-m*m)/Math.sqrt(1-m*m*d*d),l=(e+g)*(Math.cos(i)*Math.cos(b)),k=(e+g)*(Math.cos(i)*Math.sin(b)),h=(a+g)*(Math.sin(i)),f=new UNIVERSE.ECEFCoordinates(l,k,h,0,0,0,0,0,0);return f},convertECEFtoLLA:function(a){var j=new UNIVERSE.LLACoordinates(),o=a.getX(),n=a.getY(),m=a.getZ(),k=Constants.eccEarthSphere,q=Constants.radiusEarth,v=Math.sqrt((o*o)+(n*n)),i=n/v,e=o/v,f=Math.atan(i/e),l=f,d=m/v,u=Math.atan(d),r=1e-8,t=0,g=u,p=2000,s,b,h=0;while(Math.abs(g-p)>r){p=g;s=Math.sin(p);t=q/Math.sqrt(1-(k*k*s*s));b=(m+t*k*k*s)/v;g=Math.atan(b);h+=1;if(h>500){g=0;p=0}}if(l<-Math.PI){l=l+2*Math.PI}if(l>Math.PI){l=l-2*Math.PI}j.setLatitude(MathTools.toDegrees(g));j.setLongitude(MathTools.toDegrees(l));j.setAltitude(v/Math.cos(g)-t);return j},convertECItoECEF:function(f,d){var b=new UNIVERSE.ECEFCoordinates(),g=[],a,c,e;g[0]=f.getX();g[1]=f.getY();g[2]=f.getZ();a=MathTools.rot3(d,g);b.setX(a[0]);b.setY(a[1]);b.setZ(a[2]);c=[];c[0]=f.getVX();c[1]=f.getVY();c[2]=f.getVZ();a=MathTools.rot3(d,c);b.setVX(a[0]);b.setVY(a[1]);b.setVZ(a[2]);e=[];e[0]=f.getAX();e[1]=f.getAY();e[2]=f.getAZ();a=MathTools.rot3(d,e);b.setAX(a[0]);b.setAY(a[1]);b.setAZ(a[2]);return b},convertECEFtoECI:function(b,d){var f=new UNIVERSE.ECICoordinates(),g,a,c,e;g=[];g[0]=b.getX();g[1]=b.getY();g[2]=b.getZ();a=MathTools.rot3(-d,g);f.setX(a[0]);f.setY(a[1]);f.setZ(a[2]);c=[];c[0]=b.getVX();c[1]=b.getVY();c[2]=b.getVZ();a=MathTools.rot3(-d,c);f.setVX(a[0]);f.setVY(a[1]);f.setVZ(a[2]);e=[];e[0]=b.getAX();e[1]=b.getAY();e[2]=b.getAZ();a=MathTools.rot3(-d,e);f.setAX(a[0]);f.setAY(a[1]);f.setAZ(a[2]);return f},convertECItoLLA:function(c,b){var a=this.convertECItoECEF(c,b);return this.convertECEFtoLLA(a)},convertLLAtoECI:function(b,c){var a=this.convertLLAtoECEF(b);return this.convertECEFtoECI(a,c)},convertKeplerianToECI:function(d){var s=new UNIVERSE.ECICoordinates(),m=d.getSemimajorAxis(),j=d.getEccentricity(),b=m*(1-j*j),l=d.getTrueAnomaly(),f=Math.cos(MathTools.toRadians(l)),g=Math.sin(MathTools.toRadians(l)),r=b*f/(1+j*f),k=b*g/(1+j*f),h=0,o=[],n,i,c,q;o[0]=r;o[1]=k;o[2]=h;n=MathTools.rot3(-d.getArgOfPerigee(),o);n=MathTools.rot1(-d.getInclination(),n);n=MathTools.rot3(-d.getRaan(),n);s.setX(n[0]);s.setY(n[1]);s.setZ(n[2]);i=-Math.sqrt(Constants.muEarth/b)*g;c=Math.sqrt(Constants.muEarth/b)*(j+f);q=0;o[0]=i;o[1]=c;o[2]=q;n=MathTools.rot3(-d.getArgOfPerigee(),o);n=MathTools.rot1(-d.getInclination(),n);n=MathTools.rot3(-d.getRaan(),n);s.setVX(n[0]);s.setVY(n[1]);s.setVZ(n[2]);return s},convertECIToKeplerian:function(l){var E=new KeplerianCoordinates(),t=new THREE.Vector3(l.x,l.y,l.z),o=new THREE.Vector3(l.vx,l.vy,l.vz),C=new THREE.Vector3(),u,d,A,b,x,B,z,G,f,D,w,H,m,j,g,y,I,q,i,s,k,c,F;C.cross(t,o);u=C.length();d=t.length();A=o.length();b=new THREE.Vector3(0,0,1);x=new THREE.Vector3();x.cross(b,C);B=A*A-Constants.muEarth/d;z=t.dot(o);G=new THREE.Vector3((1/Constants.muEarth)*(B*t.x-z*o.x),(1/Constants.muEarth)*(B*t.y-z*o.y),(1/Constants.muEarth)*(B*t.z-z*o.z));f=G.length();D=A*A/2-Constants.muEarth/d;w=0;H=0;if(f===1){H=Infinity;w=u*u/Constants.muEarth}else{H=-Constants.muEarth/(2*D);w=H*(1-f*f)}m=MathTools.toDegrees(Math.acos(C.z/u));j=MathTools.toDegrees(Math.acos(x.x/x.length()));if(x.y<0){j=360-j}g=MathTools.toDegrees(Math.acos(x.dot(G)/(x.length()*f)));if(G.z<0){g=360-g}y=G.dot(t)/(f*d);if(y>1){y=1}I=MathTools.toDegrees(Math.acos(y));if(o.dot(t)<0){I=360-I}if(isNaN(j)){j=0.00001}if(isNaN(g)){g=0.00001}E.setSemimajorAxis(H);E.setEccentricity(f);E.setTrueAnomaly(I);E.setRaan(j);E.setInclination(m);E.setMeanMotion(MathTools.toDegrees(Math.sqrt(Constants.muEarth/(H*H*H))));E.setArgOfPerigee(g);q=Math.sin(MathTools.toRadians(I));i=Math.cos(MathTools.toRadians(I));s=((q*Math.sqrt(1-f*f))/(1+f*i));k=((f+i)/(1+f*i));c=Math.atan2(s,k);F=c-f*s;F=MathTools.toDegrees(F);E.setMeanAnomaly(F);return E},buildRotationMatrixToConvertECItoRSW:function(e){var f=CoordinateConversionTools.convertECIToKeplerian(e.getEci()),c=f.getTrueAnomaly(),a=f.getArgOfPerigee(),g=f.getInclination(),b=f.getRaan(),h=new Array(3),d=0;for(d=0;d<3;d+=1){h[d]=new Array(3)}h=MathTools.buildRotationMatrix3(b);h=MathTools.multiply2dBy2d(MathTools.buildRotationMatrix1(g),h);h=MathTools.multiply2dBy2d(MathTools.buildRotationMatrix3(a),h);h=MathTools.multiply2dBy2d(MathTools.buildRotationMatrix3(c),h);return h},convertTargetECIToSatelliteRSW:function(i,f){var d=new RSWcoordinates(),e=CoordinateConversionTools.convertECIToKeplerian(i.getEci()),a=i.getEci(),g=e.getTrueAnomaly(),j=e.getArgOfPerigee(),b=e.getInclination(),h=e.getRaan(),c=[];c[0]=f.getX()-a.getX();c[1]=f.getY()-a.getY();c[2]=f.getZ()-a.getZ();c=MathTools.rot3(h,c);c=MathTools.rot1(b,c);c=MathTools.rot3(j,c);c=MathTools.rot3(g,c);d.setRadial(c[0]);d.setAlongTrack(c[1]);d.setCrossTrack(c[2]);return d},convertRSWToECI:function(g,d){var j=new UNIVERSE.ECICoordinates(),e=CoordinateConversionTools.convertECIToKeplerian(g.getEci()),f=e.getTrueAnomaly(),i=e.getArgOfPerigee(),b=e.getInclination(),h=e.getRaan(),a=[],c;a[0]=d.radial;a[1]=d.alongTrack;a[2]=d.crossTrack;c=[];c=MathTools.rot3(-f,a);c=MathTools.rot3(-i,c);c=MathTools.rot1(-b,c);c=MathTools.rot3(-h,c);j.setX(c[0]);j.setY(c[1]);j.setZ(c[2]);return j},getSunPositionECIAtCurrentTime:function(d){var f=this.convertCurrentEpochToJulianDate(d),a=(f-2451545)/36525,b=280.4606184+36000.77005361*a,g=357.5277233+35999.05034*a,c=b+1.914666471*Math.sin(MathTools.toRadians(g))+0.019994643*Math.sin(2*MathTools.toRadians(g)),k=1.000140612-0.016708617*Math.cos(MathTools.toRadians(g))-0.000139589*Math.cos(2*MathTools.toRadians(g)),h=23.439291-0.0130042*a,j=149597870,i=new UNIVERSE.ECICoordinates();i.setX(k*Math.cos(MathTools.toRadians(c))*j);i.setY(k*Math.cos(MathTools.toRadians(h))*Math.sin(MathTools.toRadians(c))*j);i.setZ(k*Math.sin(MathTools.toRadians(h))*Math.sin(MathTools.toRadians(c))*j);return i},convertCurrentEpochToBarycentricTime:function(d){var f=new Date(d),a=new Date(f.getTime()-463),g=new Date(a.getTime()+32000),c=new Date(g.getTime()+32184),b=this.convertCurrentEpochToJulianDate(c),i=(b-2451545)/36525,h=new Date(c.getTime()+((0.001658*Math.sin(628.3076*i+6.2401))*1000)),j=this.convertCurrentEpochToJulianDate(h),e=(j-2451545)/36525;return e},getMoonPositionECIAtCurrentTime:function(c){var a=CoordinateConversionTools.convertCurrentEpochToBarycentricTime(c),b=218.32+481267.8813*a,d,g,f,i,h;b+=6.29*Math.sin(MathTools.toRadians(134.9+477198.85*a));b+=-1.27*Math.sin(MathTools.toRadians(259.2-413335.38*a));b+=0.66*Math.sin(MathTools.toRadians(235.7+890534.23*a));b+=0.21*Math.sin(MathTools.toRadians(269.9+954397.7*a));b+=-0.19*Math.sin(MathTools.toRadians(357.5+35999.05*a));b+=-0.11*Math.sin(MathTools.toRadians(186.6+966404.05*a));if(Math.abs(b)>360){b=(b%360)}if(b<0){b+=360}d=5.13*Math.sin(MathTools.toRadians(93.3+483202.03*a));d+=0.28*Math.sin(MathTools.toRadians(228.2+960400.87*a));d+=-0.28*Math.sin(MathTools.toRadians(318.3+6003.18*a));d+=-0.17*Math.sin(MathTools.toRadians(217.6-407332.2*a));if(Math.abs(d)>360){d=(d%360)}if(d<0){d+=360}g=0.9508+0.0518*Math.cos(MathTools.toRadians(134.9+477198.85*a));g+=+0.0095*Math.cos(MathTools.toRadians(259.2-413335.38*a));g+=+0.0078*Math.cos(MathTools.toRadians(235.7+890534.23*a));g+=+0.0028*Math.cos(MathTools.toRadians(269.9+954397.7*a));if(Math.abs(g)>360){g=(g%360)}if(g<0){g+=360}f=23.439291-0.0130042*a;i=1/Math.sin(MathTools.toRadians(g));i=i*Constants.radiusEarth;f=MathTools.toRadians(f);d=MathTools.toRadians(d);b=MathTools.toRadians(b);h=new UNIVERSE.ECICoordinates();h.setX(i*Math.cos(d)*Math.cos(b));h.setY(i*(Math.cos(f)*Math.cos(d)*Math.sin(b)-Math.sin(f)*Math.sin(d)));h.setZ(i*(Math.sin(f)*Math.cos(d)*Math.sin(b)+Math.cos(f)*Math.sin(d)));return h}};var CoordinateFunctionHelper={updateKeplerianAnglesUsingTrueAnomaly:function(c){var a=MathTools.toRadians(trueAnomaly),d=Math.sin(a)*Math.sqrt(1-c.eccentricity*c.eccentricity)/(1+c.eccentricity*Math.cos(a)),b=(c.eccentricity+Math.cos(a))/(1+c.eccentricity*Math.cos(a));c.eccentricAnomaly=MathTools.toDegrees(Math.atan2(d,b));c.meanAnomaly=MathTools.toDegrees(MathTools.toRadians(c.eccentricAnomaly)-c.eccentricity*d)},setKeplerianTrueAnomaly:function(a,b){a.trueAnomaly=b;updateAnglesUsingTrueAnomaly(a)}};var UNIVERSE=UNIVERSE||{};UNIVERSE.ECEFCoordinates=function(h,f,d,g,c,a,e,b,i){this.x=h||0;this.y=f||0;this.z=d||0;this.vx=g||0;this.vy=c||0;this.vz=a||0;this.ax=e||0;this.ay=b||0;this.az=i||0;this.getX=function(){return this.x};this.setX=function(j){this.x=j};this.getY=function(){return this.y};this.setY=function(j){this.y=j};this.getZ=function(){return this.z};this.setZ=function(j){this.z=j};this.getVX=function(){return this.vx};this.setVX=function(j){this.vx=j};this.getVY=function(){return this.vy};this.setVY=function(j){this.vy=j};this.getVZ=function(){return this.vz};this.setVZ=function(j){this.vz=j};this.getAX=function(){return this.ax};this.setAX=function(j){this.ax=j};this.getAY=function(){return this.ay};this.setAY=function(j){this.ay=j};this.getAZ=function(){return this.az};this.setAZ=function(j){this.az=j}};var UNIVERSE=UNIVERSE||{};UNIVERSE.ECICoordinates=function(h,f,d,g,c,a,e,b,i){this.x=h||0;this.y=f||0;this.z=d||0;this.vx=g||0;this.vy=c||0;this.vz=a||0;this.ax=e||0;this.ay=b||0;this.az=i||0};UNIVERSE.ECICoordinates.prototype={constructor:UNIVERSE.ECICoordinates,getX:function(){return this.x},setX:function(a){this.x=a},getY:function(){return this.y},setY:function(a){this.y=a},getZ:function(){return this.z},setZ:function(a){this.z=a},getVX:function(){return this.vx},setVX:function(a){this.vx=a},getVY:function(){return this.vy},setVY:function(a){this.vy=a},getVZ:function(){return this.vz},setVZ:function(a){this.vz=a},getAX:function(){return this.ax},setAX:function(a){this.ax=a},getAY:function(){return this.ay},setAY:function(a){this.ay=a},getAZ:function(){return this.az},setAZ:function(a){this.az=a}};function KeplerianCoordinates(f,g,d,e,a,b,c,i,h){this.semimajorAxis=f||0;this.meanAnomaly=g||0;this.eccentricAnomaly=g||0;this.trueAnomaly=e||0;this.inclination=a||0;this.eccentricity=b||0;this.raan=c||0;this.argOfPerigee=i||0;this.meanMotion=h||0;this.updateAnglesUsingTrueAnomaly=function(){var j=MathTools.toRadians(this.trueAnomaly),l=Math.sin(j)*Math.sqrt(1-this.eccentricity*this.eccentricity)/(1+this.eccentricity*Math.cos(j)),k=(this.eccentricity+Math.cos(j))/(1+this.eccentricity*Math.cos(j));this.EccentricAnomaly=MathTools.toDegrees(Math.atan2(l,k));this.MeanAnomaly=MathTools.toDegrees(MathTools.toRadians(this.EccentricAnomaly)-this.eccentricity*l)};this.updateAnglesUsingMeanAnomaly=function(){var k=0.00001,j=5000,o=MathTools.toRadians(this.MeanAnomaly),l=o-this.eccentricity,n=0,m=0;while(j>k){n=l+(o-l+this.eccentricity*Math.sin(l))/(1-this.eccentricity*Math.cos(l));j=Math.abs(n-l);m+=1;if(m>100){break}l=n}this.EccentricAnomaly=MathTools.toDegrees(n);this.TrueAnomaly=MathTools.toDegrees(2*Math.atan(Math.sqrt((1+this.eccentricity)/(1-this.eccentricity))*Math.tan(n/2)))};this.getSemimajorAxis=function(){return this.semimajorAxis};this.getMeanAnomaly=function(){return this.meanAnomaly};this.getEccentricAnomaly=function(){return this.eccentricAnomaly};this.getTrueAnomaly=function(){return this.trueAnomaly};this.getInclination=function(){return this.inclination};this.getEccentricity=function(){return this.eccentricity};this.getRaan=function(){return this.raan};this.getArgOfPerigee=function(){return this.argOfPerigee};this.getMeanMotion=function(){return this.meanMotion};this.setSemimajorAxis=function(j){this.semimajorAxis=j};this.setMeanAnomaly=function(j){this.meanAnomaly=j;this.updateAnglesUsingMeanAnomaly()};this.setEccentricAnomaly=function(j){this.eccentricAnomaly=j};this.setTrueAnomaly=function(j){this.trueAnomaly=j;this.updateAnglesUsingTrueAnomaly()};this.setInclination=function(j){this.inclination=j};this.setEccentricity=function(j){this.eccentricity=j};this.setRaan=function(j){this.raan=j};this.setArgOfPerigee=function(j){this.argOfPerigee=j};this.setMeanMotion=function(j){this.meanMotion=j}}var UNIVERSE=UNIVERSE||{};UNIVERSE.LLACoordinates=function(b,c,a){this.latitude=b||0;this.longitude=c||0;this.altitude=a||0;this.getAltitude=function(){return this.altitude};this.setAltitude=function(d){this.altitude=d};this.getLatitude=function(){return this.latitude};this.setLatitude=function(d){this.latitude=d};this.getLongitude=function(){return this.longitude};this.setLongitude=function(d){this.longitude=d}};var MathTools={angleBetweenTwoVectorsVector:function(a,f){var e,d=a.length(),c=f.length(),b=a.dot(f);e=MathTools.toDegrees(Math.acos(b/(d*c)));if(e>90){e=180-e}return e},rot1:function(b,c){b=MathTools.toRadians(b);var a=[];a[0]=c[0];a[1]=Math.cos(b)*c[1]+Math.sin(b)*c[2];a[2]=-Math.sin(b)*c[1]+Math.cos(b)*c[2];return a},rot2:function(b,c){b=MathTools.toRadians(b);var a=[];a[0]=Math.cos(b)*c[0]-Math.sin(b)*c[2];a[1]=c[1];a[2]=Math.sin(b)*c[0]+Math.cos(b)*c[2];return a},rot3:function(b,c){b=MathTools.toRadians(b);var a=[];a[0]=Math.cos(b)*c[0]+Math.sin(b)*c[1];a[1]=-Math.sin(b)*c[0]+Math.cos(b)*c[1];a[2]=c[2];return a},toRadians:function(a){return a*Constants.piOverOneEighty},toDegrees:function(a){return a*Constants.oneEightyOverPi},buildRotationMatrix1:function(b){b=MathTools.toRadians(b);var a=[],c=0;for(c=0;c<3;c+=1){a[c]=[]}a[0][0]=1;a[0][1]=0;a[0][2]=0;a[1][0]=0;a[1][1]=Math.cos(b);a[1][2]=-Math.sin(b);a[2][0]=0;a[2][1]=Math.sin(b);a[2][2]=Math.cos(b);return a},buildRotationMatrix2:function(b){b=MathTools.toRadians(b);var a=[],c=0;for(c=0;c<3;c+=1){a[c]=[]}a[0][0]=Math.cos(b);a[0][1]=0;a[0][2]=Math.sin(b);a[1][0]=0;a[1][1]=1;a[1][2]=0;a[2][0]=-Math.sin(b);a[2][1]=0;a[2][2]=Math.cos(b);return a},buildRotationMatrix3:function(b){b=MathTools.toRadians(b);var a=[],c=0;for(c=0;c<3;c+=1){a[c]=[]}a[0][0]=Math.cos(b);a[0][1]=-Math.sin(b);a[0][2]=0;a[1][0]=Math.sin(b);a[1][1]=Math.cos(b);a[1][2]=0;a[2][0]=0;a[2][1]=0;a[2][2]=1;return a},ones:function(d){var a=[],c=0,b=0;for(c=0;c<d;c+=1){for(b=0;b<d;b+=1){if(c!==b){a[c][b]=0}else{a[c][b]=1}}}return a},zeros:function(d){var a=[],c=0,b=0;for(c=0;c<d;c+=1){for(b=0;b<d;b+=1){a[c][b]=0}}return a},zeros:function(e,d){var a=[],c=0,b=0;for(c=0;c<e;c+=1){for(b=0;b<d;b+=1){a[c][b]=0}}return a},multiply1dBy2d:function(k,f){var a=k.length,h=f.length,g=f[0].length,e=[],d,b,c;if(a!==h){return null}for(d=0;d<g;d+=1){b=0;for(c=0;c<a;c+=1){b=b+k[c]*f[c][d]}e[d]=b}return e},multiply2dBy1d:function(k,h){var g=k.length,d=k[0].length,a=h.length,f,e,b,c;if(d!==a){return null}f=[];for(e=0;e<g;e+=1){b=0;for(c=0;c<a;c+=1){b=b+k[e][c]*h[c]}f[e]=b}return f},multiplyDoubleBy2d:function(d,a){var g=a.length,e=a[0].length,f=[],c=0,b=0;for(c=0;c<g;c+=1){f[c]=[]}for(c=0;c<g;c+=1){for(b=0;b<e;b+=1){if(a[c][b]===0){f[c][b]=0}else{f[c][b]=d*a[c][b]}}}return f},multiply2dBy2d:function(n,h){var b=n.length,a=n[0].length,m=h.length,l=h[0].length,g,f,e,c,d;if(a!==m){return null}g=[];for(f=0;f<b;f+=1){g[f]=[]}for(f=0;f<b;f+=1){for(e=0;e<l;e+=1){c=0;for(d=0;d<m;d+=1){c=c+n[f][d]*h[d][e]}g[f][e]=c}}return g},transposeMatrix:function(a){var d=a.length,b=a[0].length,f=[],e=0,c=0;for(e=0;e<b;e+=1){f[e]=[]}for(e=0;e<d;e+=1){for(c=0;c<b;c+=1){f[c][e]=a[e][c]}}return f},add1dTo1d:function(a,f){var b=a.length,e=f.length,d,c;if(b!==e){return null}d=[];for(c=0;c<b;c+=1){d[c]=a[c]+f[c]}return d},add2dTo2d:function(k,f){var b=k.length,a=k[0].length,h=f.length,g=f[0].length,e=[],d,c;if((b!==h)||(a!==g)){return null}for(d=0;d<b;d+=1){e[d]=[]}for(d=0;d<b;d+=1){for(c=0;c<a;c+=1){e[d][c]=k[d][c]+f[d][c]}}return e},subtract2dMinus2d:function(k,f){var b=k.length,a=k[0].length,h=f.length,g=f[0].length,e=[],d,c;if((b!==h)||(a!==g)){return null}for(d=0;d<b;d+=1){e[d]=[]}for(d=0;d<b;d+=1){for(c=0;c<a;c+=1){e[d][c]=k[d][c]-f[d][c]}}return e},subtract1dMinus1d:function(a,f){var b=a.length,e=f.length,d=[],c;if(b!==e){return null}for(c=0;c<b;c+=1){d[c]=a[c]-f[c]}return d}};function Quaternion(a,d,c,b){this.w=a||0;this.x=d||0;this.y=c||0;this.z=b||0;this.q=[];this.updateQ=function(){this.q[0]=this.w;this.q[1]=this.x;this.q[2]=this.y;this.q[3]=this.z};this.getQ=function(){return this.q};this.setQ=function(e){this.w=e[0];this.x=e[1];this.y=e[2];this.z=e[3];this.q=e};this.getW=function(){return this.w};this.setW=function(e){this.w=e;this.updateQ()};this.getX=function(){return this.x};this.setX=function(e){this.x=e;this.updateQ()};this.getY=function(){return this.y};this.setY=function(e){this.y=e;this.updateQ()};this.getZ=function(){return this.z};this.setZ=function(e){this.z=e;this.updateQ()};this.isZero=function(){var e;for(e=0;e<4;e+=1){if(this.q[e]&&this.q[e]!==0){return false}}return true}}var QuaternionMath={multiplyQuaternions:function(h,g){if(h.isZero()){return g}else{if(g.isZero()){return h}else{var f=h.getW(),b=h.getX(),j=h.getY(),d=h.getZ(),e=g.getW(),a=g.getX(),i=g.getY(),c=g.getZ(),k=new Quaternion();k.setW(f*e-b*a-j*i-d*c);k.setX(f*a+b*e+j*c-d*i);k.setY(f*i+j*e+d*a-b*c);k.setZ(f*c+d*e+b*i-j*a);return k}}},applyQuaternionRotation:function(h,c){var j=h.getW(),g=h.getX(),f=h.getY(),e=h.getZ(),b=[],d,a;for(d=0;d<3;d+=1){b[d]=new Array(3)}b[0][0]=2*j*j-1+2*g*g;b[0][1]=2*g*f+2*j*e;b[0][2]=2*g*e-2*j*f;b[1][0]=2*g*f-2*j*e;b[1][1]=2*j*j-1+2*f*f;b[1][2]=2*f*e+2*j*g;b[2][0]=2*g*e+2*j*f;b[2][1]=2*f*e-2*j*g;b[2][2]=2*j*j-1+2*e*e;a=MathTools.multiply2dBy1d(b,[c.x,c.y,c.z]);return new THREE.Vector3(a[0],a[1],a[2])},getEulerAngles:function(a){var i=a.getW(),g=a.getX(),f=a.getY(),e=a.getZ(),h=Math.atan2((2*(i*g+f*e)),(1-2*(g*g+f*f))),b=Math.asin(2*(i*f-e*g)),d=Math.atan2((2*(i*e+g*f)),(1-2*(f*f+e*e))),c=[];c[0]=MathTools.toDegrees(h);c[1]=MathTools.toDegrees(b);c[2]=MathTools.toDegrees(d);return c},convertRotationMatrixToQuaternion:function(e){var b=new Quaternion(),h=e[0][0],g=e[0][1],f=e[0][2],d=e[1][0],c=e[1][1],a=e[1][2],k=e[2][0],j=e[2][1],i=e[2][2];b.setW(0.5*Math.sqrt(1+h-c-i));b.setX((g+d)/(4*b.getW()));b.setY((f+k)/(4*b.getW()));b.setZ((j-a)/(4*b.getW()));return b}};var UNIVERSE=UNIVERSE||{};UNIVERSE.RSWCoordinates=function(a,c,b){this.radial=a||0;this.alongTrack=c||0;this.crossTrack=b||0};var Utilities={get_random_color:function(){var c=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],a="0x",b;for(b=0;b<6;b+=1){a+=c[Math.round(Math.random()*15)]}return a},eciTo3DCoordinates:function(a,b){if(!a){return undefined}return{x:(a.y)*Math.sin(-b.rotationOffsetFromXAxis)+(-a.x)*Math.cos(-b.rotationOffsetFromXAxis),y:a.z,z:a.y*Math.cos(-b.rotationOffsetFromXAxis)-(-a.x)*Math.sin(-b.rotationOffsetFromXAxis),vx:-a.vx,vy:a.vz,vz:a.vy}},threeDToEciCoordinates:function(a,b){if(!a){return undefined}return{x:(a.y)*Math.sin(b.rotationOffsetFromXAxis)+(-a.x)*Math.cos(b.rotationOffsetFromXAxis),y:a.z,z:a.y*Math.cos(b.rotationOffsetFromXAxis)-(-a.x)*Math.sin(b.rotationOffsetFromXAxis),vx:-a.vx,vy:a.vz,vz:a.vy}}};UNIVERSE.EarthExtensions=function(d,e){var b=this,c=false,a=false;this.enableVisibilityLines=false;this.enableSensorProjections=false;this.enableSensorFootprintProjections=false;this.lockCameraToWithEarthRotation=false;this.rotationOffsetFromXAxis=0;this.useSunLighting=e||true;this.defaultObjects=new UNIVERSE.DefaultObjects(d);this.addEarth=function(f,h){var g=new UNIVERSE.Earth(d,b,f,h);d.addObject(g);d.updateOnce()};this.addMoon=function(g){var f=new UNIVERSE.Moon(d,b,g);d.addObject(f);d.updateOnce()};this.addSun=function(){var f=new UNIVERSE.Sun(d,b);d.addObject(f);d.updateOnce()};this.addSpaceObject=function(h,i){var g,f;d.getObjectFromLibraryById(h.modelId,function(j){g=j;d.getObjectFromLibraryById("default_material",function(k){d.addObject(h.getGraphicsObject(k,g,d,b));d.updateOnce();i()})})};this.addDefaultSpaceObject=function(g,f,k,s,r,o,m,p,l,i,h,q){var j=new UNIVERSE.ECICoordinates(r,o,m,p,l,i,0,0,0);var n=new UNIVERSE.SpaceObject(g,f,"",function(w,u){if(!w){w=d.getCurrentUniverseTime()}var v=w-h;dt=100;var t=OrbitPropagator.propagateOrbit(j,v/1000,dt,h);this.currentLocation=t;return t},true,true,[],j,d,b);n.showVehicle=true;this.addSpaceDot(n,k,s,q);return n};this.addSpaceDot=function(k,g,h,l){var i,f="dot_"+g;if(h){i="ground_dot_size_"+h}else{i="default_ground_object_geometry"}try{d.getObjectFromLibraryById(i,function(n){try{d.getObjectFromLibraryById(f,function(o){d.addObject(k.getGraphicsObject(o,n,d,b));d.updateOnce();l()})}catch(m){d.setObjectInLibrary(f,new THREE.MeshBasicMaterial({color:g}));b.addSpaceDot(k,g,h,l)}})}catch(j){d.setObjectInLibrary(i,new THREE.SphereGeometry(h,h/10,h/20));b.addSpaceDot(k,g,h,l)}};this.addSensorVisibilityLines=function(f,h){if(f.sensors&&f.sensors.length>0){var g=new UNIVERSE.SensorVisibilityLinesController(f,d,b);d.addObject(g);d.updateOnce();h()}};this.addGroundObject=function(g,j){var i,f,h;if(!g.modelId){g.modelId="default_ground_object_geometry";h="default_ground_object_material"}else{h="default_material"}d.getObjectFromLibraryById(g.modelId,function(k){i=k;d.getObjectFromLibraryById(h,function(l){d.addObject(g.getGraphicsObject(l,i,d,b));d.updateOnce();j()})})};this.addStaticGroundDot=function(h,g,i,n,l,f,k,m){var j=new UNIVERSE.GroundObject(h,g,null,function(){return CoordinateConversionTools.convertLLAtoECI(new UNIVERSE.LLACoordinates(l,f,k),CoordinateConversionTools.convertTimeToGMST(d.getCurrentUniverseTime()))});this.addGroundDot(j,i,n,m)};this.addGroundDot=function(f,h,i,l){var j,g="dot_"+h;if(i){j="ground_dot_size_"+i}else{j="default_ground_object_geometry"}try{d.getObjectFromLibraryById(j,function(n){try{d.getObjectFromLibraryById(g,function(o){d.addObject(f.getGraphicsObject(o,n,d,b));d.updateOnce();l()})}catch(m){d.setObjectInLibrary(g,new THREE.MeshBasicMaterial({color:h}));b.addGroundDot(f,h,i,l)}})}catch(k){d.setObjectInLibrary(j,new THREE.SphereGeometry(i,i/10,i/20));b.addGroundDot(f,h,i,l)}};this.addGroundTrackPointForObject=function(g,i){var h,f;d.getObjectFromLibraryById("default_ground_object_geometry",function(j){h=j;d.getObjectFromLibraryById("default_ground_track_material",function(k){var l=new UNIVERSE.GroundTrackPoint(g,d,b,k,h);d.addObject(l);d.updateOnce();i()})})};this.addPropogationLineForObject=function(g,i){var h,f;h=new THREE.Geometry();d.getObjectFromLibraryById("default_orbit_line_material",function(j){var k=new UNIVERSE.PropogationLine(g,d,b,j,h);d.addObject(k);d.updateOnce();i()})};this.addSensorProjection=function(f,i){var h=Utilities.eciTo3DCoordinates(i.propagator(undefined,false),b),g;if(h){g=UNIVERSE.SensorProjection(f,i,d,b,h);d.addObject(g);d.updateOnce()}};this.addSensorProjections=function(g,h){var f;if(g.sensors.length>0){for(f=g.sensors.length-1;f>=0;f-=1){this.addSensorProjection(g.sensors[f],g)}h()}};this.addSensorFootprintProjections=function(g,h){var f;if(g.sensors.length>0){for(f=0;f<g.sensors.length;f+=1){this.addSensorFootprintProjection(g.sensors[f],g)}h()}};this.addSensorFootprintProjection=function(g,h){var f=new UNIVERSE.SensorFootprintProjection(g,h,d,b);d.addObject(f);d.updateOnce()};this.addClosestGroundObjectTracingLine=function(f){var h,g=new UNIVERSE.GraphicsObject(f.id+"_controlLine",f.objectName,undefined,function(i){var k=Utilities.eciTo3DCoordinates(f.propagator(undefined,false),b),j=b.findClosestGroundObject(k);if(j!==undefined&&j.id!==h){b.removeLineBetweenObjects(f.id,h);h=j.id;b.addLineBetweenObjects(f.id,h)}},function(){});d.addObject(g);d.updateOnce()};this.addLineBetweenObjects=function(j,h,f,i){var g=new UNIVERSE.LineBetweenObjects(j,h,d,b,f,i);d.addObject(g)};this.removeLineBetweenObjects=function(i,g,h){var f="_to_";if(h){f=h}d.removeObject(i+f+g)};this.removeAllLinesBetweenObjects=function(){var f=d.getGraphicsObjects(),g;for(g in f){if(g.indexOf("_to_")>-1){d.removeObject(g)}}};this.findClosestGroundObject=function(f){if(f){var g=new THREE.Vector3(f.x,f.y,f.z);g.multiplyScalar(Constants.radiusEarth/g.length());return b.findClosestObject({x:g.x,y:g.y,z:g.z})}return undefined};this.findClosestObject=function(g){var h=d.getGraphicsObjects(),n,l,k=new THREE.Vector3(g.x,g.y,g.z),j,f,m;for(j in h){if(h[j].currentLocation){f=new THREE.Vector3(h[j].currentLocation.x,h[j].currentLocation.y,h[j].currentLocation.z);m=f.distanceTo(k);if(n===undefined||m<n){l=h[j];n=m}}}return l};this.showAllOrbitLines=function(h){var f=d.getGraphicsObjects(),g;a=h;for(g in f){if(f[g].id.indexOf("_propogation")!==-1){d.showObject(f[g].id,h)}}};this.showOrbitLineForObject=function(f,g){d.showObject(g+"_propogation",f)};this.showModelForId=function(f,g){d.showObject(g,f)};this.showAllGroundTracks=function(h){var f=d.getGraphicsObjects(),g;c=h;for(g in f){if(f[g].id.indexOf("_groundPoint")!==-1){d.showObject(f[g].id,h)}}};this.showGroundTrackForId=function(f,g){d.showObject(g+"_groundPoint",f)};this.showAllSensorProjections=function(h){var f=d.getGraphicsObjects(),g;this.enableSensorProjections=h;for(g in f){if(f[g].id.indexOf("_sensorProjection")!==-1){d.showObject(f[g].id,h)}}};this.showSensorProjectionForId=function(g,j){var h=d.getGraphicsObjects(),f;for(f in h){if(f.indexOf(j+"_sensorProjection")>-1){d.showObject(f,g)}}};this.showAllSensorFootprintProjections=function(h){var f=d.getGraphicsObjects(),g;this.enableSensorFootprintProjections=h;for(g in f){if(f[g].id.indexOf("_footprint")!==-1){d.showObject(f[g].id,h)}}};this.showSensorFootprintProjectionsForId=function(h,j){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id.indexOf(j)!==-1&&f[g].id.indexOf("_footprint")!==-1){d.showObject(f[g].id,h)}}};this.showSensorVisibilityLinesForId=function(h,j){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id.indexOf(j+"_visibility_")!==-1){d.showObject(f[g].id,h)}}};this.showAllSensorVisibilityLines=function(h){var f=d.getGraphicsObjects(),g;this.enableVisibilityLines=h;for(g in f){if(f[g].id.indexOf("_visibility_")!==-1){d.showObject(f[g].id,h)}}};this.showAllLinesBetweenObjects=function(h){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id.indexOf("_to_")!==-1){d.showObject(f[g].id,h)}}};this.showLineBetweenObjectsForId=function(h,j){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id.indexOf(j+"_to_")!==-1||f[g].id.indexOf("_to_"+j)!==-1){d.showObject(f[g].id,h)}}};this.lockCameraPositionRelativeToEarth=function(f){this.lockCameraToWithEarthRotation=f};this.setSunLighting=function(f){b.useSunLighting=f;d.showObject("earth",!f);d.showObject("earth_day",f);d.showObject("earth_night",f)};this.removeAllExceptEarthAndMoon=function(){var f=d.getGraphicsObjects(),g;for(g in f){if(f[g].id!=="earth"&&f[g].id!=="moon"&&f[g].id!=="sun"){d.removeObject(f[g].id)}}};this.setup=function(){this.removeAllExceptEarthAndMoon();d.setup()}};